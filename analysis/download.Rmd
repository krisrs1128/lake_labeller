---
title: "Download Sentinel 2 Imagery"
output: html_notebook
params:
  year: 2019
  month: 8
  n_months: 4
  lake_ids: [1, 10]
  
---
```{r, echo = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r}
library(glue)
library(lakes)
library(lubridate)
library(reticulate)
library(sf)
library(terra)
library(tidyverse)
use_condaenv("lakes_labeller")
```


```{r}
data(lakes)
start_date <- ymd(str_c(params$year, "-", params$month, "-01"))
end_date <- start_date %m+% months(params$n_months)
date_range <- paste(c(start_date, end_date), collapse = "/")
lakes_proj <- st_transform(lakes, st_crs("epsg:32645"))
```


```{r}
cur_lake <- lakes %>%
  filter(row_number() %in% seq(params$lake_ids[1], params$lake_ids[2]))

links <- list()
for (gl_id in cur_lake$GL_ID) {
  cur_lake <- filter(lakes, GL_ID == gl_id)
  links[[gl_id]] <- scenes_metadata(date_range, st_bbox(cur_lake)) %>%
    mutate(
      p.datetime = as_datetime(p.datetime),
      date = date(p.datetime)
    )
  cur_lake <- st_transform(cur_lake, st_crs("epsg:32645"))
  
  timepoints <- unique(links[[gl_id]]$id)
  for (i in seq_along(timepoints)) {
    out_path <- glue("{gl_id}_{links[[gl_id]]$date[1]}.tif")
    cur_links <- filter(links[[gl_id]], id == timepoints[i])
    bbox <- st_bbox(st_buffer(cur_lake, 1e3))
    read_windows(cur_links$link, bbox) %>%
      writeRaster(out_path, overwrite = TRUE)
  }
}

```
```{r}
bind_rows(links, .id = "GL_ID") %>%
  write_csv(glue("metadata_{params$year}_{params$month}_{params$lake_ids[1]}-{params$lake_ids[2]}.csv"))
```

